/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java application project to get you started.
 * For more details on building Java & JVM projects, please refer to https://docs.gradle.org/8.6/userguide/building_java_projects.html in the Gradle documentation.
 */

plugins {
    // Apply the application plugin to add support for building a CLI application in Java.
    id 'application'
    id 'java'
}

repositories {
    // Use Maven Central for resolving dependencies.
    mavenCentral()
}

dependencies {
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.9.1'
    testImplementation 'org.junit.jupiter:junit-jupiter:5.9.1'

    implementation project(':mendix-agent')
    // https://mvnrepository.com/artifact/io.opentelemetry.javaagent/opentelemetry-javaagent
    // https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/download/v2.0.0/opentelemetry-javaagent.jar
    implementation 'io.opentelemetry.javaagent:opentelemetry-javaagent:2.0.0'
    configurations {
        implementation {
            // 下载源码
            transitive = true
        }
    }
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
}

application {
    mainClass = 'org.example.App'
}

tasks.named('test') {
    useJUnitPlatform()
}

jar {
    manifest {
        attributes(
            'Main-Class': 'org.example.App'
        )
    }
}

tasks.withType(JavaExec) {
    def agentJar = configurations.runtimeClasspath.resolvedConfiguration.resolvedArtifacts.find { 
            it.moduleVersion.id.group == 'io.opentelemetry.javaagent' && 
            it.moduleVersion.id.name == 'opentelemetry-javaagent' 
    }

    if (agentJar != null) {
        jvmArgs = [
            "-javaagent:${agentJar.file.absolutePath}",
            "-javaagent:../mendix-agent/build/libs/mendix-agent-1.0.0.jar=org.example.App#getGreeting",
            "-Dotel.service.name=my_procode_app",
            "-Dotel.exporter=jaeger",
            "-Dotel.exporter.jaeger.endpoint=http://localhost:14268/api/traces",
            "-Dotel.traces.sampler=always_on"
        ]
    } else {
        println "OpenTelemetry Java Agent not found in dependencies."
    }
}